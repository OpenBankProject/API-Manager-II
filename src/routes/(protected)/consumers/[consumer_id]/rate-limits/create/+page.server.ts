import { createLogger } from "$lib/utils/logger";
import { obp_requests } from "$lib/obp/requests";
import { error, fail, redirect } from "@sveltejs/kit";
import type { RequestEvent } from "@sveltejs/kit";

const logger = createLogger("CreateConsumerRateLimitServer");

interface Consumer {
  consumer_id: string;
  app_name: string;
  app_type: string;
  description: string;
  developer_email: string;
  enabled: boolean;
  created: string;
}

export async function load(event: RequestEvent) {
  const token = event.locals.session.data.oauth?.access_token;
  if (!token) {
    error(401, {
      message: "Unauthorized: No access token found in session.",
    });
  }

  const consumerId = event.params.consumer_id;
  if (!consumerId) {
    error(400, {
      message: "Consumer ID is required.",
    });
  }

  let consumer: Consumer | undefined = undefined;

  try {
    // Fetch consumer details
    consumer = await obp_requests.get(
      `/obp/v6.0.0/management/consumers/${consumerId}`,
      token,
    );

    logger.debug(`Retrieved consumer: ${consumer?.app_name}`);
  } catch (e) {
    logger.error("Error fetching consumer:", e);
    error(404, {
      message: "Consumer not found.",
    });
  }

  if (!consumer) {
    error(404, {
      message: "Consumer not found.",
    });
  }

  return {
    consumer,
  };
}

export const actions = {
  default: async (event: RequestEvent) => {
    const token = event.locals.session.data.oauth?.access_token;
    if (!token) {
      return fail(401, {
        error: "Unauthorized: No access token found in session.",
      });
    }

    const consumerId = event.params.consumer_id;
    if (!consumerId) {
      return fail(400, {
        error: "Consumer ID is required.",
      });
    }

    const formData = await event.request.formData();
    const from_date = formData.get("from_date") as string;
    const to_date = formData.get("to_date") as string;
    const per_second_call_limit = formData.get(
      "per_second_call_limit",
    ) as string;
    const per_minute_call_limit = formData.get(
      "per_minute_call_limit",
    ) as string;
    const per_hour_call_limit = formData.get("per_hour_call_limit") as string;
    const per_day_call_limit = formData.get("per_day_call_limit") as string;
    const per_week_call_limit = formData.get("per_week_call_limit") as string;
    const per_month_call_limit = formData.get("per_month_call_limit") as string;
    const bank_id = formData.get("bank_id") as string;
    const api_name = formData.get("api_name") as string;
    const api_version = formData.get("api_version") as string;

    // Validation
    if (!from_date || !to_date) {
      return fail(400, {
        error: "From date and To date are required.",
        from_date,
        to_date,
      });
    }

    // Validate that at least one limit is set
    const hasLimit =
      per_second_call_limit ||
      per_minute_call_limit ||
      per_hour_call_limit ||
      per_day_call_limit ||
      per_week_call_limit ||
      per_month_call_limit;

    if (!hasLimit) {
      return fail(400, {
        error: "At least one rate limit must be specified.",
        from_date,
        to_date,
      });
    }

    // Build request body - format dates as ISO 8601 with time
    // Convert YYYY-MM-DD to YYYY-MM-DDT00:00:00.000Z
    const fromDateISO = `${from_date}T00:00:00.000Z`;
    const toDateISO = `${to_date}T23:59:59.999Z`;

    const requestBody: any = {
      from_date: fromDateISO,
      to_date: toDateISO,
      per_second_call_limit: per_second_call_limit || "",
      per_minute_call_limit: per_minute_call_limit || "",
      per_hour_call_limit: per_hour_call_limit || "",
      per_day_call_limit: per_day_call_limit || "",
      per_week_call_limit: per_week_call_limit || "",
      per_month_call_limit: per_month_call_limit || "",
    };

    try {
      logger.debug(`Creating rate limit for consumer ${consumerId}`);

      await obp_requests.post(
        `/obp/v6.0.0/management/consumers/${consumerId}/consumer/rate-limits`,
        requestBody,
        token,
      );

      logger.info(`Successfully created rate limit for consumer ${consumerId}`);
    } catch (e: any) {
      logger.error("Error creating rate limit:", e);
      return fail(500, {
        error: e.message || "Failed to create rate limit. Please try again.",
        from_date,
        to_date,
      });
    }

    // Redirect back to rate limits page
    throw redirect(303, `/consumers/${consumerId}/rate-limits`);
  },
};
